name: SSH Test
on:
  workflow_call:
    inputs:
      REMOTE:
        type: string
        description: "The remote folder to deploy to."
        required: true
      asset_folder_name:
        type: string
        default: "build"
        description: "The name of the folder that gets generated in the build step. Default: build"
        required: false
      theme_name:
        type: string
        default: "macros-by-sara"
        description: "The name of the theme to deploy. Default: macros-by-sara-theme"
        required: false
      flags:
        type: string
        default: "-azr --delete"
        description: "Optional flags to pass to the rsync command during deployment. Default: -azr --delete"
        required: false

jobs:
  build-and-bundle:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set up Node.js
        uses: actions/setup-node@v6

      - name: Install dependencies
        run: npm ci

      - name: Run build
        run: npm run build

      - name: Read files array from package.json
        id: files
        run: |
          FILES=$(jq -r '.files | join(" ")' package.json)
          echo "files=$FILES" >> $GITHUB_OUTPUT

      - name: Bundle theme
        run: |
          mkdir "${{ inputs.theme_name }}"
          cp -r ${{ steps.files.outputs.files }} "${{ inputs.theme_name }}/"

      - name: Upload theme bundle artifact
        uses: actions/upload-artifact@v5
        with:
          name: ${{ inputs.theme_name }}
          path: ${{ inputs.theme_name }}/

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-bundle
    steps:
      - name: Download theme bundle artifact
        uses: actions/download-artifact@v6
        with:
          name: ${{ inputs.theme_name }}
          path: ${{ inputs.theme_name }}

      - name: Configure SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/gha-sg-mbs
          chmod 600 ~/.ssh/gha-sg-mbs
          ssh-keyscan -H ${{ secrets.REMOTE_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy theme via rsync
        run: |
          echo "Deploying theme directory to ${{ inputs.REMOTE }}"
          RSYNC_OPTS="${{ inputs.flags }}"
          rsync --progress $RSYNC_OPTS \
          -e "ssh -i ~/.ssh/gha-sg-mbs -p ${{ secrets.REMOTE_PORT }} -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null" \
          "${{ inputs.theme_name }}/" \
          "${{ secrets.REMOTE_USER }}@${{ secrets.REMOTE_HOST }}:www/${{ inputs.REMOTE }}/public_html/wp-content/themes/${{ inputs.theme_name }}/"
